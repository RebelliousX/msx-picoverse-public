# MSX PicoVerse 2040 プロジェクト

|PicoVerse 表面|PicoVerse 裏面|
|---|---|
|![PicoVerse 表面](/images/2025-12-02_20-05.png)|![PicoVerse 裏面](/images/2025-12-02_20-06.png)|

PicoVerse 2040 は、Raspberry Pi Pico をベースにした MSX 用カートリッジで、交換可能なファームウェアを利用してコンピュータの機能を拡張します。異なるファームウェアイメージを読み込むことで、カートリッジは MSX のゲームやアプリケーションを実行したり、ROM マッパーや追加 RAM、ストレージインターフェースなどの追加ハードウェアデバイスをエミュレートして仮想周辺機器を提供できます。その一例が MultiROM システムで、カートリッジ内に保存された複数の ROM タイトルを参照・起動するためのオンスクリーンメニューを提供します。

また、カートリッジは Pico の USB‑C ポートをマスストレージとして露出させることができ、PC から ROM、DSK、その他のファイルをカートリッジに直接コピーできます。

さらに、+240 KB メモリマッパーをサポートする Nextor ファームウェアバリアントを使用すると、メモリが限られた MSX システムでも PicoVerse 2040 ハードウェアをフルに活用できます。

現在の PicoVerse 2040 カートリッジで利用可能な機能:

* 複数の MSX ROM を選択・起動するための MultiROM メニューシステム。
* オプションで +240 KB メモリマッパーをサポートする Nextor OS。
* ROM や DSK を読み込むための USB マスストレージサポート。
* 各種 MSX ROM マッパーのサポート（PL-16, PL-32, KonSCC, Linear, ASC-08, ASC-16, Konami, NEO-8, NEO-16）。
* MSX、MSX2、MSX2+ システムとの互換性。

## MultiROM UF2 生成ツールのマニュアル

このセクションでは、PicoVerse 2040 カートリッジに書き込む UF2 イメージ（`multirom.uf2`）を生成するコンソールツール `multirom` について説明します。

既定動作では、`multirom` ツールはディレクトリ内の MSX ROM ファイルをスキャンし、それらを単一の UF2 イメージにパッケージ化して Raspberry Pi Pico に書き込めるようにします。生成されるイメージには通常、Pico のファームウェア、MultiROM メニュー ROM、各 ROM エントリを記述する設定領域、および ROM ペイロード自体が含まれます。

オプションに応じて、`multirom` は MultiROM メニューの代わりにカスタムファームウェアで直接ブートする UF2 を生成することもできます。たとえば、Nextor を実装するファームウェアを含む UF2 を生成することが可能です。このモードでは、Pico の USB‑C ポートを Nextor からの ROM や DSK の読み込み用マスストレージとして使用できます（例: SofaRun を介して）。

## 概要

オプションなしで実行すると、`multirom.exe` はカレントワーキングディレクトリ内の MSX ROM ファイル（`.ROM` または `.rom`）をスキャンし、各 ROM のマッパータイプを推定し、各 ROM の設定（名前、マッパーバイト、サイズ、オフセット）を記述する設定テーブルを作成して MSX メニュー ROM のスライスに埋め込みます。ツールは Pico ファームウェアバイナリ、メニュー ROM のスライス、設定領域、ROM ペイロードを連結して `multirom.uf2` という UF2 ファイルにシリアライズします。

生成された UF2 ファイル（通常 `multirom.uf2`）を Pico の USB マスストレージデバイスにコピーすると、結合イメージをフラッシュできます。BOOTSEL ボタンを押しながら Pico を接続して UF2 フラッシュモードに入る必要があります。`RPI-RP2` という名前の新しい USB ドライブが表示され、そこに `multirom.uf2` をコピーします。コピーが完了したら Pico を取り外し、カートリッジを MSX に挿入して MultiROM メニューを起動します。

ROM ファイル名は MSX メニューのエントリ名として使われます。名前は最大 50 文字まで使用できます。長い名前はスクロール表示されますが、50 文字を超えると切り詰められます。

Nextor を使用する場合は、埋め込み Nextor ROM をイメージに含めるために `-s1` または `-s2` オプションでツールを実行する必要があります。`-s1` はメモリマッパーなしの標準 Nextor ROM を含み、`-s2` は +240 KB メモリマッパーを備えた Nextor ROM を含みます。埋め込み Nextor ROM はブート時に単一のファームウェアとして読み込まれ、MultiROM メニューは利用できません。その後 SofaRun を使用して Pico の USB マスストレージから ROM や DSK を読み込めます。

重要: 標準の USB メモリを使用するには、USB‑C を標準 USB‑A メスに変換する OTG アダプタやケーブルが必要な場合があります。

## コマンドライン使用法

現時点では Microsoft Windows 実行ファイルのみ提供されています (`multirom.exe`)。

### 基本的な使い方:

```
multirom.exe [options]
```

### オプション:
- `-n`, `--nextor`: 設定からベータ版の埋め込み NEXTOR ROM を含めて出力します。このオプションはまだ実験的で、現時点では特定の MSX2 モデルでしか動作しません。
- `-h`, `--help`: ヘルプを表示して終了します。
- `-o <filename>`, `--output <filename>`: UF2 出力ファイル名を設定します（デフォルトは `multirom.uf2`）。
- `-s1`: カートリッジは Sunrise IDE Nextor（メモリマッパーなし）で起動します。
- `-s2`: カートリッジは Sunrise IDE Nextor（+240 KB メモリマッパー）で起動します。
- `-s1` も `-s2` も指定しない場合、ツールはメニュー付きの MultiROM イメージを生成します。
- 特定の ROM ファイルに対してマッパーを強制する必要がある場合、ファイル名の `.ROM` 拡張子の前にマッパータグを付けることができます。タグは大文字小文字を区別しません。例えば `Knight Mare.PL-32.ROM` と命名すると、その ROM に対して PL-32 マッパーの使用が強制されます。`SYSTEM` のようなタグは無視されます。

### 例
- カレントディレクトリのすべての `.ROM` を含む MultiROM メニュー付きの `multirom.uf2` を生成する:
```
multirom.exe
```

- Sunrise IDE Nextor ROM（メモリマッパーなし）を含む `multirom.uf2` を生成する:
```
multirom.exe -s1
```
- Sunrise IDE Nextor ROM（+240 KB メモリマッパー）を含む `multirom.uf2` を生成する:
```
multirom.exe -s2
```

## 動作の仕組み（高レベル）

1. ツールはカレントワーキングディレクトリをスキャンして `.ROM` または `.rom` で終わるファイルを探します。各ファイルについて:
   - 表示名（拡張子なしのファイル名、50 文字に切り詰め）を抽出します。
   - ファイルサイズを取得し、`MIN_ROM_SIZE` と `MAX_ROM_SIZE` の間であることを検証します。
   - `detect_rom_type()` を呼び出して、設定エントリに使用するマッパーバイトをヒューリスティックに判定します。ファイル名にマッパータグがある場合は検出を上書きします。
   - 検出が失敗した場合、そのファイルはスキップされます。
   - 各 ROM の設定レコード（50 バイト名、1 バイトマッパー、4 バイトサイズ LE、4 バイトフラッシュオフセット LE）を設定領域にシリアライズします。
2. スキャン終了後、ツールは次を連結します（順序は重要）: 組み込み Pico ファームウェアバイナリ、MSX メニュー ROM の先頭スライス（`MENU_COPY_SIZE` バイト）、設定領域全体（`CONFIG_AREA_SIZE` バイト）、オプションの NEXTOR ROM、そして発見された ROM ペイロード。
3. 結合ペイロードは `multirom.uf2` という名前の UF2 ファイルとして書き込まれ、`create_uf2_file()` により Pico フラッシュアドレス `0x10000000` をターゲットにした 256 バイトの UF2 ブロックが生成されます。

## マッパー検出のヒューリスティクス
- `detect_rom_type()` は署名チェック（"AB" ヘッダ、`ROM_NEO8` / `ROM_NE16` タグ）とオペコードやアドレスのヒューリスティックなスキャンを組み合わせて、一般的な MSX マッパーを選択します（例示であり限定ではありません）:
  - Plain 16KB (mapper byte 1) — 16KB AB ヘッダチェック
  - Plain 32KB (mapper byte 2) — 32KB AB ヘッダチェック
  - Linear0 mapper (mapper byte 4) — 特殊な AB レイアウトチェック
  - NEO8 (mapper byte 8) と NEO16 (mapper byte 9)
  - Konami, Konami SCC, ASCII8, ASCII16 などは重み付けスコアで判定
- 信頼できるマッパーが検出できない場合、ツールは ROM をスキップして "unsupported mapper" を報告します。ファイル名のタグでマッパーを強制できます。
- 設定領域とメニューでサポートされるマッパーは次の通りです: `PL-16,  PL-32,  KonSCC,  Linear,  ASC-08,  ASC-16,  Konami,  NEO-8,  NEO-16`

## MSX ROM セレクタメニューの使用法

PicoVerse 2040 カートリッジを挿入して MSX の電源を入れると、MultiROM メニューが表示され、利用可能な ROM の一覧が示されます。キーボードの矢印キーでメニューを操作できます。

上/下 の矢印キーで選択カーソルを移動します。ROM が 19 個を超える場合は、左/右 の矢印キーでページを切り替えます。

Enter または Space キーで選択中の ROM を起動します。MSX は適切なマッパー設定を使って ROM をブートしようとします。

メニュー内ではいつでも `H` キーを押すと基本的な説明を表示するヘルプ画面が開きます。任意のキーを押すとメインメニューに戻ります。

## PicoVerse 2040 で Nextor を使う

`-s1` または `-s2` オプションでカートリッジに Nextor ファームウェアをフラッシュした場合、カートリッジは MultiROM メニューではなく直接 Nextor を起動します。これらのオプションはメモリマップド I/O を使って MSX と通信するため、カートリッジは標準のカートリッジスロットに挿入する必要があります。

Nextor が動作していると、SofaRun や他の Nextor 対応ランチャーを使って Pico の USB マスストレージから ROM や DSK を読み込めます。標準の USB-A メモリを接続するには OTG アダプタやケーブルが必要になる場合があります。

MSX2 または MSX2+ システムで +240 KB メモリ版 Nextor（S2 オプション）を使用すると、カートリッジはシステムに追加メモリを提供し、BIOS のブートシーケンスに増加した RAM が反映されます。一部の MSX 機種は起動時に合計拡張メモリを表示します。

ツールの `-n` オプションは特定の MSX2 機種で使用できる実験的な埋め込み Nextor ROM を含めます。ただしこのオプションは開発中であり、すべての機種で動作するとは限りません。このバージョンは IO ポートベースの別の方法で MSX と通信し、標準/拡張されていないカートリッジスロットでも動作する可能性があります。

詳細は Nextor-Pico-Bridge-Protocol.md と Sunrise-Nextor.md を参照してください。

### Nextor 用 USB メモリの準備方法

1. USB メモリを PC に接続します。
2. USB メモリに最大 4GB の FAT16 パーティションを作成します。OS 標準ツールまたはサードパーティのパーティションツールを使用できます。
3. Nextor のシステムファイルを FAT16 パーティションのルートにコピーします。Nextor の配布またはリポジトリから取得できます。コマンドシェル用の `COMMAND2` ファイルも必要です:
   1. [Nextor Download Page](https://github.com/Konamiman/Nextor/releases)
   2. [Command2 Download Page](http://www.tni.nl/products/command2.html)
4. 使用したい MSX ROM（`.ROM`）やディスクイメージ（`.DSK`）をルートにコピーします。
5. SofaRun や他の Nextor 対応ランチャーを USB メモリにインストールする場合は、起動用にコピーします。SofaRun は次から入手できます: [SofaRun](https://www.louthrax.net/mgr/sofarun.html)
6. USB メモリを安全に取り外します。

## 改善案
- ROM タイプ検出のヒューリスティクスを改善し、より多くのマッパーやエッジケースをサポートする。
- 各 ROM エントリ用の設定画面（名前、マッパー上書きなど）を実装する。
- より多くの ROM マッパーをサポートする。
- ナビゲーションや ROM 情報表示を改善したグラフィカルメニューを実装する。
- メニュー設定の保存/読み込みをサポートし、ユーザープリファレンスを保持する。
- DSK ファイルもサポートし、適切な設定エントリを生成する。
- マッパー検出アルゴリズムを改良してより多くのケースをカバーする。
- カスタムメニュー ROM スライスやテーマをサポートする。
- URL から ROM をダウンロードして直接埋め込む機能を追加する。
- 外部 ESP-01 モジュール経由の無線（WiFi）サポートを追加する。
- ジョイスティックでメニューを操作できるようにする。
- ROM を圧縮して容量を節約する機能を追加する。

## 既知の問題

- 埋め込み Nextor ROM の取り扱いはまだ実験的で、すべての MSX2 機種で動作するとは限りません。
- 非常に珍しいマッパーを使用した ROM は正しく検出されない場合があり、有効なマッパーをファイル名タグで強制しないとスキップされます。
- 現在ツールは Windows 実行ファイルのみをサポートしており、Linux や macOS 版は提供されていません。
- ツールはファイルの整合性をサイズと基本的なヘッダチェック以外で検証しません。破損した ROM は予期せぬ動作を引き起こす可能性があります。
- MultiROM メニューは DSK ファイルをサポートしておらず、ROM のみが一覧表示・起動されます。
- ツールはサブディレクトリをサポートしていません。カレントディレクトリ内の ROM のみを処理します。
- Pico のフラッシュメモリは書き込みサイクルを繰り返すと摩耗します。過度な再書き込みは避けてください。

## テスト済み MSX モデル

| モデル | 種類 | 状態 | コメント |
| --- | --- | --- | --- |
| Adermir Carchano Expert 4 | MSX2+ | OK | 動作確認済み |
| Gradiente Expert | MSX1 | OK | 動作確認済み |
| JFF MSX | MSX1 | OK | 動作確認済み |
| MSX Book | MSX2+ (FPGA クローン) | OK | 動作確認済み |
| MSX One | MSX1 | Not OK | カートリッジが認識されない |
| National FS-4500 | MSX1 | OK | 動作確認済み |
| Panasonic FS-A1GT | TurboR | OK | 動作確認済み |
| Panasonic FS-A1ST | TurboR | OK | 動作確認済み |
| Panasonic FS-A1WX | MSX2+ | OK | 動作確認済み |
| Panasonic FS-A1WSX | MSX2+ | OK | 動作確認済み |
| Sharp HotBit HB8000 | MSX1 | OK | 動作確認済み |
| SMX-HB | MSX2+ (FPGA クローン) | OK | 動作確認済み |
| Sony HB-F1XD | MSX2 | OK | 動作確認済み |
| Sony HB-F1XDJ | MSX2 | OK | 動作確認済み |
| Sony HB-F1XV | MSX2+ | OK | 動作確認済み |
| TRHMSX | MSX2+ (FPGA クローン) | OK | 動作確認済み |
| uMSX | MSX2+ (FPGA クローン) | OK | 動作確認済み |
| Yamaha YIS604 | MSX1 | OK | 動作確認済み |

Sunrise Nextor +240K ファームウェアは次の機種でテストされています:

| モデル | 状態 | コメント |
| --- | --- | --- |
| MSX1 | | |
| Sharp HotBit HB8000 (MSX1) | Not OK | メモリマッパーが機能せず、Nextor が動作しない |
| MSX2+ | | |
| TRHMSX (MSX2+, FPGA クローン) | OK | 動作確認済み |
| uMSX (MSX2+, FPGA クローン) | OK | 動作確認済み |

作成者: Cristiano Almeida Goncalves
最終更新日: 12/20/2025
