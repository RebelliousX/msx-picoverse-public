# MSX PicoVerse 2040 プロジェクト

|PicoVerse 前面|PicoVerse 背面|
|---|---|
|![PicoVerse Front](/images/2025-12-02_20-05.png)|![PicoVerse Back](/images/2025-12-02_20-06.png)|

PicoVerse 2040 は、交換可能なファームウェアで機能を拡張できる Raspberry Pi Pico ベースの MSX 用カートリッジです。異なるファームウェアイメージを読み込むことで、MSX 用のゲームやアプリケーションを実行したり、ROM マッパーや追加 RAM、ストレージインターフェースなどのハードウェア機能をエミュレートして仮想周辺機器を追加できます。MultiROM システムはその一例で、カートリッジに格納された複数の ROM タイトルを画面上のメニューから選択・起動できる機能を提供します。

このカートリッジは Pico の USB‑C ポートをマスストレージデバイスとして露出させることもでき、Windows や Linux の PC から ROM や DSK、その他のファイルを直接コピーできます。

また、+240 KB のメモリマッパーをサポートする Nextor ファームウェアを使用することで、メモリ制約のある MSX システムでも PicoVerse 2040 ハードウェアを最大限に活用できます。

現行バージョンの PicoVerse 2040 カートリッジで利用可能な機能は以下の通りです:

* 複数の MSX ROM を選択・起動するための MultiROM メニューシステム
* オプションで +240 KB メモリマッパーをサポートする Nextor OS
* ROM や DSK の読み込みに対応した USB マスストレージサポート
* 各種 MSX ROM マッパーのサポート（PL-16, PL-32, KonSCC, Linear, ASC-08, ASC-16, Konami, NEO-8, NEO-16）
* MSX、MSX2、MSX2+ との互換性

## MultiROM UF2 作成マニュアル

このセクションでは、PicoVerse 2040 カートリッジをプログラムする UF2 イメージ（multirom.uf2）を生成するためのコンソールツール `multirom` について説明します。

デフォルトの動作では、`multirom` ツールはディレクトリ内の MSX ROM ファイルをスキャンし、それらを単一の UF2 イメージにパッケージ化して Raspberry Pi Pico に書き込めるようにします。生成されるイメージは通常、Pico のファームウェア、MultiROM の MSX メニュー ROM、各 ROM エントリを記述する設定領域、および ROM ペイロード本体を含みます。

> 注意: 1 つのイメージに含められる ROM の最大数は 128 個、合計サイズの上限はおおよそ 16 MB です。

オプションによっては、`multirom` は MultiROM メニューの代わりにカスタムファームウェアへ直接ブートする UF2 イメージを生成することもできます。例えば、Nextor OS を実装したファームウェアを含む UF2 を作成するオプションがあります。このモードでは Pico の USB‑C ポートが Nextor からの ROM や DSK、その他のファイル読み込み用のマスストレージとして使用可能になります（例: SofaRun 経由）。

## 概要

オプションなしで実行した場合、`multirom.exe` は作業ディレクトリ内の MSX ROM ファイル（`.ROM` または `.rom`）をスキャンし、各 ROM のマッパー種別を推測して、各 ROM を記述する設定テーブル（名前、マッパーバイト、サイズ、オフセット）を作成し、これを MSX メニュー ROM の一部に組み込みます。その後ツールは Pico のファームウェア、本体のメニュースライス、設定領域、ROM ペイロードを連結し、全体を `multirom.uf2` という UF2 ファイルにシリアライズします。

![alt text](/images/2025-11-29_20-49.png)

生成された UF2 ファイル（通常は multirom.uf2）は、Pico の USB マスストレージデバイスにコピーしてフラッシュできます。UF2 書き込みモードに入るには BOOTSEL ボタンを押しながら Pico を接続します。すると `RPI-RP2` という名前の USB ドライブが現れ、そこに `multirom.uf2` をコピーします。コピーが完了したら Pico を切断し、カートリッジを MSX に挿入して MultiROM メニューを起動できます。

ROM ファイル名は MSX メニューのエントリ名として使用されます。名前の上限は 50 文字です。長い名前はメニュー上でスクロール表示されますが、50 文字を超えると切り詰められます。

![alt text](/images/multirom_2040_menu.png)

Nextor を PicoVerse 2040 カートリッジで使用するには、ツールを `-s1` または `-s2` オプション付きで実行して埋め込みの Nextor ROM をイメージに含める必要があります。`-s1` はメモリマッパーを使用しない標準の Nextor ROM、`-s2` は +240 KB のメモリマッパーを含む Nextor ROM を含めます。埋め込みの Nextor ROM はブート時に単一のファームウェアとして読み込まれ、MultiROM メニューは利用できなくなります。その後 SofaRun を使って Pico の USB マスストレージから ROM や DSK を読み込めます。

> 注意: USB メモリを使用する場合、USB‑C を標準の USB‑A に変換する OTG アダプタやケーブルが必要になることがあります。

> 注意: `-n` オプションは特定の MSX2 モデルで動作する実験的な埋め込み Nextor ROM を含めます。このバージョンは IO ポートベースの異なる通信方式を使用するため、すべてのシステムで動作するとは限りません。

## コマンドラインの使い方

現時点では Microsoft Windows 用の実行ファイル（`multirom.exe`）のみが提供されています。

### 基本的な使い方:

```
multirom.exe [options]
```

### オプション:
- `-n`, `--nextor` : 設定にあるベータ版の NEXTOR ROM を埋め込んで出力します。このオプションは実験的で、現時点では特定の MSX2 モデルでのみ動作します。
- `-h`, `--help`   : ヘルプを表示して終了します。
- `-o <filename>`, `--output <filename>` : 出力する UF2 ファイル名を指定します（デフォルトは `multirom.uf2`）。
- `-s1`            : カートリッジは Sunrise IDE Nextor（メモリマッパーなし）で起動します。
- `-s2`            : カートリッジは Sunrise IDE Nextor（+240 KB メモリマッパー）で起動します。
- `-s1` も `-s2` も指定しない場合、ツールはメニューを含む MultiROM イメージを生成します。
- ROM ファイルに対して特定のマッパー種別を強制したい場合は、ファイル名の `.ROM` 拡張子の前にマッパータグを付加できます。タグは大文字小文字を区別しません。例えば `Knight Mare.PL-32.ROM` とするとその ROM に対して PL-32 マッパーを強制します。`SYSTEM` のようなタグは無視されます。利用可能なタグの一覧は次の通りです: `PL-16,  PL-32,  KonSCC,  Linear,  ASC-08,  ASC-16,  Konami,  NEO-8,  NEO-16`

### 例
- カレントディレクトリ内のすべての `.ROM` ファイルを含む MultiROM メニュー付きの multirom.uf2 を生成します。コマンドプロンプトから実行するか、実行ファイルをダブルクリックして起動できます:
  ```
  multirom.exe
  ```

- Sunrise IDE Nextor ROM（メモリマッパーなし）を含む multirom.uf2 を生成する例:
  ```
  multirom.exe -s1
  ```
- Sunrise IDE Nextor ROM（+240 KB メモリマッパー）を含む multirom.uf2 を生成する例:
  ```
  multirom.exe -s2
  ```

## 動作の仕組み（概要）

1. ツールはカレントディレクトリ内で拡張子が `.ROM` または `.rom` のファイルをスキャンします。各ファイルについて:
   - 表示名を抽出します（拡張子を除いたファイル名、50 文字に切り詰め）。
   - ファイルサイズを取得し、`MIN_ROM_SIZE` と `MAX_ROM_SIZE` の範囲内であることを検証します。
   - `detect_rom_type()` を呼び出して設定エントリに使用するマッパーバイトをヒューリスティックに判定します。ファイル名にマッパータグが含まれている場合は検出を上書きします。
   - マッパー検出に失敗した場合、そのファイルはスキップされます。
   - 各 ROM の設定レコード（50 バイト名、1 バイトマッパー、4 バイトサイズ（リトルエンディアン）、4 バイトフラッシュオフセット（リトルエンディアン））を設定領域にシリアライズします。
2. スキャン後、ツールは次の順で連結します: 埋め込み Pico ファームウェア バイナリ、MSX メニュー ROM の先頭スライス（`MENU_COPY_SIZE` バイト）、完全な設定領域（`CONFIG_AREA_SIZE` バイト）、オプションの NEXTOR ROM、そして検出された ROM ペイロード（検出順）。
3. 結合したペイロードは `create_uf2_file()` により `multirom.uf2` として書き出されます。これは Pico のフラッシュアドレス `0x10000000` をターゲットにした 256 バイトのペイロード UF2 ブロックを生成します。

## マッパー検出のヒューリスティクス
- `detect_rom_type()` は署名チェック（"AB" ヘッダ、`ROM_NEO8` / `ROM_NE16` タグ）やオペコード・アドレスのヒューリスティック走査を組み合わせ、一般的な MSX マッパーを判定します。判定されるマッパーには以下が含まれます（これに限定されません）:
  - プレーン 16KB （マッパーバイト 1） — 16KB の AB ヘッダチェック
  - プレーン 32KB （マッパーバイト 2） — 32KB の AB ヘッダチェック
  - Linear0 マッパー（マッパーバイト 4） — 特殊な AB レイアウトチェック
  - NEO8（マッパーバイト 8）および NEO16（マッパーバイト 9）
  - Konami、Konami SCC、ASCII8、ASCII16 など（重み付けスコアによる判定）
- 十分に信頼できるマッパーが検出できない場合、ツールはその ROM をスキップし "unsupported mapper" を報告します。ファイル名タグでマッパーを強制することも可能です。タグは大文字小文字を区別しません。下記のタグがサポートされています。
- 設定領域とメニューでサポートされるマッパーは次の通りです: `PL-16,  PL-32,  KonSCC,  Linear,  ASC-08,  ASC-16,  Konami,  NEO-8,  NEO-16`

## MSX ROM セレクターメニューの使い方

PicoVerse 2040 カートリッジを挿入して MSX の電源を入れると、MultiROM メニューが表示され、利用可能な ROM の一覧が表示されます。キーボードの矢印キーでメニューを操作できます。

![alt text](/images/multirom_2040_menu.png)

上矢印・下矢印キーで選択カーソルを移動します。ROM が 19 個以上ある場合は、左右の矢印キーでページを切り替えて一覧をスクロールできます。

Enter キーまたは Space キーを押すと選択中の ROM が起動します。MSX は適切なマッパー設定で ROM のブートを試みます。

メニュー内ではいつでも H キーを押すとヘルプ画面が表示されます。任意のキーを押すとメインメニューに戻ります。

## PicoVerse 2040 カートリッジで Nextor を使う

カートリッジを Nextor ファームウェアでフラッシュしている場合（`-s1` または `-s2` オプション使用）、カートリッジは MultiROM メニューの代わりに直接 Nextor を起動します。これらのオプションはメモリマップド I/O を使用して MSX と通信するため、カートリッジはプライマリカートリッジスロットに挿入する必要があります。

Nextor が動作している状態では、SofaRun やその他の Nextor 対応ランチャーを使って Pico の USB マスストレージから ROM や DSK を読み込めます。標準の USB‑A メモリを接続するには USB OTG アダプタやケーブルが必要になる場合があります。

MSX2 や MSX2+ システムで +240 KB メモリ版の Nextor（`-s2` オプション）を使用すると、カートリッジがシステムに追加メモリを提供し、BIOS の起動表示に増設 RAM が反映されます。一部の MSX 機種では起動時に合計拡張メモリを表示します。

multirom ツールの `-n` オプションは、特定の MSX2 機種で使える実験的な埋め込み Nextor ROM を含みます。ただしこのオプションは開発段階であり、すべての環境で動作する保証はありません。このバージョンは IO ポートベースの別方式で MSX と通信するため、スロットエクスパンダ等でカートリッジスロットがプライマリでない環境でも動作する可能性があります。

MSX と通信するプロトコルの詳細は Nextor-Pico-Bridge-Protocol.md ドキュメントを参照してください。Sunrise IDE Nextor ファームウェアとの通信の詳細は Sunrise-Nextor.md を参照してください。

### Nextor 用のサムドライブの準備方法

Nextor を PicoVerse 2040 カートリッジで使用するための USB サムドライブの準備手順は次の通りです:

1. USB サムドライブを PC に接続します。
2. サムドライブに対して最大 4GB の FAT16 パーティションを作成します。内蔵の Nextor OS ツール（MSX Basic 上で CALL FDISK）やサードパーティのパーティションツールを使用できます。
3. Nextor のシステムファイルを FAT16 パーティションのルートディレクトリにコピーします。Nextor のシステムファイルは公式配布やリポジトリから入手できます。コマンドシェル用の COMMAND2 ファイルも必要です:
   1.  [Nextor ダウンロードページ](https://github.com/Konamiman/Nextor/releases)
   2.  [Command2 ダウンロードページ](http://www.tni.nl/products/command2.html)
4. Nextor で使用したい MSX ROM（`.ROM`）やディスクイメージ（`.DSK`）をサムドライブのルートにコピーします。
5. SofaRun やその他の Nextor 対応ランチャーをサムドライブにインストールしておくと、ROM や DSK の起動に便利です。SofaRun は次の公式サイトから入手できます: [SofaRun](https://www.louthrax.net/mgr/sofarun.html)
6. サムドライブを PC から安全に取り外します。
7. 必要に応じて USB OTG アダプタやケーブルを使ってサムドライブを PicoVerse 2040 カートリッジに接続します。

> 注意: すべての USB サムドライブが PicoVerse 2040 カートリッジと互換性があるわけではありません。問題が発生した場合は別のブランドやモデルを試してください。
>
> 注意: Nextor は動作に最低 128 KB の RAM を必要とします。標準の Nextor ファームウェア（`-s1` オプション）を使用する場合、MSX に十分な RAM があることを確認してください。

## 改善案
- ROM 種別検出のヒューリスティクスを改良して、より多くのマッパーやエッジケースに対応する。
- 各 ROM エントリの設定画面（名前、マッパー上書き等）を実装する。
- さらに多くの ROM マッパーをサポートする。
- ナビゲーションや ROM 情報表示を改善したグラフィカルメニューを実装する。
- ユーザー設定を保持するためのメニュー設定の保存/読み込み機能を追加する。
- DSK ファイルのサポート（適切な設定エントリを含む）を追加する。
- メニュー用のカスタムテーマサポートを追加する。
- インターネットの URL から ROM をダウンロードして直接埋め込む機能を追加する。
- ジョイスティックでメニューを操作できるようにする。

## 既知の問題

- 埋め込み Nextor ROM の取り込みはまだ実験的で、すべての MSX2 機種で動作するとは限りません。
- 一部の珍しいマッパーを持つ ROM は正しく検出されず、正しいマッパータグで強制指定しない限りスキップされることがあります。
- MultiROM ツールは現時点で Windows のみをサポートしています。Linux や macOS 版は未提供です。
- ツールは現在、サイズや基本的なヘッダチェック以外の ROM ファイルの完全性を検証しません。破損した ROM は予期しない動作を引き起こす可能性があります。
- 複数ファイルを単一の UF2 に埋め込む性質上、ウイルス対策ソフトが実行ファイルを疑わしいものとして検出することがあります。これは誤検知であることが多いですが、信頼できる配布元からダウンロードしてください。
- MultiROM メニューは DSK ファイルをサポートしていません。ROM ファイルのみが一覧表示および起動対象です。
- ツールはサブディレクトリをサポートしていません。処理対象はカレントディレクトリ内の ROM ファイルのみです。
- Pico のフラッシュメモリは書き込み回数に上限があり、頻繁な再フラッシュは避けてください。

## テスト済み MSX 機種

MultiROM ファームウェアを搭載した PicoVerse 2040 カートリッジは、以下の MSX 機種で動作確認を行っています:

| Model | Type | Status | Comments |
| --- | --- | --- | --- |
| Adermir Carchano Expert 4 | MSX2+ | OK | 動作確認済み |
| Gradiente Expert | MSX1 | OK | 動作確認済み |
| JFF MSX | MSX1 | OK | 動作確認済み |
| MSX Book | MSX2+ (FPGA clone) | OK | 動作確認済み |
| MSX One | MSX1 | Not OK | カートリッジが認識されない |
| National FS-4500 | MSX1 | OK | 動作確認済み |
| Panasonic FS-A1GT | TurboR | OK | 動作確認済み |
| Panasonic FS-A1ST | TurboR | OK | 動作確認済み |
| Panasonic FS-A1WX | MSX2+ | OK | 動作確認済み |
| Panasonic FS-A1WSX | MSX2+ | OK | 動作確認済み |
| Sharp HotBit HB8000 | MSX1 | OK | 動作確認済み |
| SMX-HB | MSX2+ (FPGA clone) | OK | 動作確認済み |
| Sony HB-F1XD | MSX2 | OK | 動作確認済み |
| Sony HB-F1XDJ | MSX2 | OK | 動作確認済み |
| Sony HB-F1XV | MSX2+ | OK | 動作確認済み |
| TRHMSX | MSX2+ (FPGA clone) | OK | 動作確認済み |
| uMSX | MSX2+ (FPGA clone) | OK | 動作確認済み |
| Yamaha YIS604 | MSX1 | OK | 動作確認済み |

Sunrise Nextor +240K ファームウェアを搭載した PicoVerse 2040 カートリッジは、以下の MSX 機種でテストされています:

| Model | Type | Status | Comments |
| --- | --- | --- | --- |
| Sharp HotBit HB8000 (MSX1) | MSX1| Not OK | メモリマッパーが動作せず Nextor が機能しない |
| TRHMSX (MSX2+, FPGA clone) | MSX2+ |  OK | 動作確認済み |
| uMSX (MSX2+, FPGA clone) | MSX2+ | OK | 動作確認済み

作成者: Cristiano Almeida Goncalves
最終更新: 12/21/2025